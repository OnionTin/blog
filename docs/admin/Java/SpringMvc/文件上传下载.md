## 文件上传下载

```xml
<!-- pom.xml -->
<dependencies>
  <dependency>
    <groupId>commons-fileupload</groupId>
    <artifactId>commons-fileupload</artifactId>
    <version>1.3.3</version>
  </dependency>
  <dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>javax.servlet-api</artifactId>
    <version>4.0.1</version>
  </dependency>
</dependencies>
```

```xml
<!-- springmvc.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mvc="http://www.springframework.org/schema/mvc"
  xmlns:context="http://www.springframework.org/schema/context"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans.xsd
  http://www.springframework.org/schema/mvc
  https://www.springframework.org/schema/mvc/spring-mvc.xsd
  http://www.springframework.org/schema/context
  https://www.springframework.org/schema/context/spring-context.xsd">

  <context:component-scan base-package="com.haha.controller"/>

  <!-- Json乱码问题配置 -->
  <mvc:annotation-driven>
    <mvc:message-converters register-defaults="true">
      <!--消息转化机制-->
      <bean class="org.springframework.http.converter.StringHttpMessageConverter">
        <constructor-arg value="UTF-8"/>
      </bean>
      <bean class="org.springframework.http.converter.json.MappingJackson2HttpMessageConverter">
        <property name="objectMapper">
          <bean class="org.springframework.http.converter.json.Jackson2ObjectMapperFactoryBean">
            <property name="failOnEmptyBeans" value="false"/>
          </bean>
        </property>
      </bean>
    </mvc:message-converters>
  </mvc:annotation-driven>

  <mvc:default-servlet-handler/>
  <bean class="org.springframework.web.servlet.view.InternalResourceViewResolver" id="InternalResourceViewResolver">
    <property name="prefix" value="/WEB-INF/jsp/"/>
    <property name="suffix" value=".jsp"/>
  </bean>

  <!--拦截器配置-->
  <mvc:interceptors>
    <mvc:interceptor>
      <!--/**：所有请求都拦截-->
      <mvc:mapping path="/**"/>
      <!--执行文件-->
      <bean class="com.haha.config.MyInterceptor"/>
    </mvc:interceptor>
  </mvc:interceptors>

  <!--文件上传配置（id不能改）-->
  <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
    <!--请求的编码格式，必须和jsp的pageEncoding属性一致，默认是ISO-8859-1-->
    <property name="defaultEncoding" value="UTF-8"/>
    <!--文件大小限制：单位是字节(10485760 = 10M)-->
    <property name="maxUploadSize" value="10485760"/>
    <property name="maxInMemorySize" value="40960"/>
  </bean>
</beans>
```

```java
package com.haha.controller;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.commons.CommonsMultipartFile;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.*;
import java.net.URLEncoder;

@RestController
public class FileController {
  // 上传方式一：
  // @RequestParam("file")：将name=file控件得到的文件封装成CommonsMultipartFile对象
  // 批量上传文件，CommonsMultipartFile[] files，文件数组即可
  @RequestMapping("/upload1")
  public String upload(@RequestParam("file") CommonsMultipartFile file, HttpServletRequest request) throws IOException {
    // 获取文件名
    String filename = file.getOriginalFilename();
    // 如果文件名为空，直接返回
    if (filename == null || filename.trim().equals("")) {
      return "文件名为空";
    }
    // 上传路径保存设置
    String path = request.getServletContext().getRealPath("/upload");
    // 路径不存在就创建一个
    File realPath = new File(path);
    if (!realPath.exists()) {
      realPath.mkdir();
    }
    System.out.println("上传文件保存路径:" + realPath);
    // 文件输入流
    InputStream is = file.getInputStream();
    // 文件输出流
    OutputStream os = new FileOutputStream(new File(realPath, filename));
    // 读写操作
    int len = 0;
    byte[] buffer = new byte[1024];
    while ((len = is.read(buffer)) != -1) {
      os.write(buffer, 0, len);
      os.flush();
    }
    os.close();
    is.close();
    return "上传成功";
  }

  // 上传方式二
  @RequestMapping("/upload2")
  public String upload2(@RequestParam("file") CommonsMultipartFile file, HttpServletRequest request) throws IOException {
    // 上传路径保存设置
    String path = request.getServletContext().getRealPath("/upload");
    File realPath = new File(path);
    if (!realPath.exists()) {
      realPath.mkdir();
    }
    System.out.println("上传文件保存路径:" + realPath);
    // 通过CommonsMultipartFile的方法直接写文件（注意这个时候）
    file.transferTo(new File(realPath + "/" + file.getOriginalFilename()));
    return "上传成功";
  }

  // 文件下载
  @RequestMapping("/download")
  public String download(HttpServletRequest request, HttpServletResponse response) throws Exception {
    // 要下载的文件地址和文件名（只需要修改这块即可，其他都固定的）
    String path = request.getServletContext().getRealPath("/upload");
    String filename = "一码双流-功能说明书_发货通知单查询.doc";
    // 设置响应头
    response.reset();
    response.setCharacterEncoding("UTF-8");
    response.setContentType("multipart/form-data");
    // 设置响应头
    response.setHeader("Content-Disposition", "attachment;filename=" + URLEncoder.encode(filename, "UTF-8"));

    File file = new File(path, filename);
    // 输入流
    InputStream input = new FileInputStream(file);
    // 输出流
    OutputStream output = response.getOutputStream();

    byte[] buffer = new byte[1024];
    int len = 0;
    while ((len = input.read(buffer)) != -1) {
      output.write(buffer, 0, len);
      output.flush();
    }
    output.close();
    input.close();
    return "下载成功";
  }
}
```
