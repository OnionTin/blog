## 生产者服务

> 生产者服：给消费者服务提供接口调用的 spring-boot 项目

### 依赖

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project
  xmlns="http://maven.apache.org/POM/4.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
  http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <parent>
    <artifactId>ths-spring-cloud</artifactId>
    <groupId>org.ths</groupId>
    <version>1.0-SNAPSHOT</version>
  </parent>
  <modelVersion>4.0.0</modelVersion>

  <artifactId>project-provider-8001</artifactId>

  <properties>
    <maven.compiler.source>8</maven.compiler.source>
    <maven.compiler.target>8</maven.compiler.target>
  </properties>

  <dependencies>
    <!--因为需要实体类，所以需要导入project-api模块-->
    <dependency>
      <groupId>org.ths</groupId>
      <artifactId>project-api</artifactId>
      <version>1.0-SNAPSHOT</version>
    </dependency>
    <!--junit-->
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
    </dependency>
    <!--数据库-->
    <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
    </dependency>
    <!--数据库的数据源-->
    <dependency>
      <groupId>com.alibaba</groupId>
      <artifactId>druid</artifactId>
    </dependency>
    <!--logback日志-->
    <dependency>
      <groupId>ch.qos.logback</groupId>
      <artifactId>logback-core</artifactId>
    </dependency>
    <!--springboot启动器-->
    <dependency>
      <groupId>org.mybatis.spring.boot</groupId>
      <artifactId>mybatis-spring-boot-starter</artifactId>
    </dependency>
    <!--springboot-test-->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-test</artifactId>
      <scope>test</scope>
    </dependency>
    <!--热部署工具：保存后就可以自动根本更新了，不用重启-->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-devtools</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
  </dependencies>

</project>
```

### 项目配置

```yaml
server:
  port: 8001
# mybatis配置
mybatis:
  # 配置别名：实体类包名路径(api模块)
  type-aliases-package: com.ths.api.pojo
  # 配置mapper接口的位置(当前模块)
  mapper-locations: classpath:mybatis/mapper/*.xml
  # 配置全局配置文件(当前模块)
  config-location: classpath:mybatis/mybatis-config.xml
# spring配置
spring:
  application:
    name: project-provider-8001
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/db01?useUnicode=
      true&characterEncoding=utf-8&serverTimezone=UTC
    username: root
    password: 123456
    # 配置连接池
    dbcp2:
      initialSize: 5
      # 最小连接池数量
      minIdle: 5
      # 最大连接池数量
      maxTotal: 20
      # 最大等待时间，配置了maxWait毫秒的线程如果获取连接失败，则抛出异常
      maxWaitMillis: 5000
      # 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
      timeBetweenEvictionRunsMillis: 60000
      # 配置一个连接在池中最小生存的时间，单位是毫秒
      minEvictableIdleTimeMillis: 300000
      # 连接有效性检查的 SQL 查询
      validationQuery: SELECT 1
      # 是否在空闲时进行连接有效性检查
      testWhileIdle: true
      # 是否在获取连接时进行连接有效性检查
      testOnBorrow: false
      # 是否在归还连接时进行连接有效性检查
      testOnReturn: false
      # 是否缓存 PreparedStatemen
      poolPreparedStatements: true
      # 每个连接缓存的最大 PreparedStatement 数量
      maxPoolPreparedStatementPerConnectionSize: 20
      # 配置过滤器，如统计、防火墙、日志等
      filters: stat,wall,log4j
```

### mybatis 配置文件

```xml
<!--mybatis-config.xml-->
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
  <settings>
    <!--自动将数据库中的下划线命名（如 user_name）转换为 Java 中的驼峰命名（如 userName）-->
    <setting name="mapUnderscoreToCamelCase" value="true"/>
    <!--开启二级缓存-->
    <setting name="cacheEnabled" value="true"/>
    <!--日志输出的方式-->
    <setting name="logImpl" value="STDOUT_LOGGING"/>
    <!--懒加载提高性能-->
    <setting name="lazyLoadingEnabled" value="true"/>
    <!--控制是否启用激进的懒加载策略，false只对关联对象进行按需加载，true对所有关联对象进行一次性加载-->
    <setting name="aggressiveLazyLoading" value="false"/>
    <!--多结果集支持-->
    <setting name="multipleResultSetsEnabled" value="true"/>
    <!--执行插入操作后自动获取并设置生成的主键值-->
    <setting name="useGeneratedKeys" value="true"/>
  </settings>
</configuration>
```

### 映射文件接口

```java
package com.ths.provider.mapper;

import com.ths.api.pojo.Dept;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

import java.util.List;

@Mapper
@Repository // 同@Component一样，交给Spring托管，dao层使用@Repository
public interface DeptMapper {
  public List<Dept> queryAll();

  public Dept queryById(Long id);

  public boolean addDept(Dept dept);

  public boolean deleteDept(Long id);

  public boolean updateDept(Dept dept);
}
```

### 映射文件

```xml
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ths.provider.mapper.DeptMapper">
  <resultMap id="DeptResultMap" type="com.ths.api.pojo.Dept">
    <id property="deptno" column="deptno"/>
    <result property="dname" column="dname"/>
    <result property="db_source" column="db_source"/>
  </resultMap>
  <!--resultType="com.ths.api.pojo.Dept",默认映射,可能有潜在问题-->
  <select id="queryAll" resultMap="DeptResultMap">
    select * from dept
  </select>
  <select id="queryById" resultMap="DeptResultMap">
    select * from dept where deptno=#{id}
  </select>
  <insert id="addDept" parameterType="com.ths.api.pojo.Dept">
    insert into dept(dname,db_source) values(#{dname},DATABASE())
  </insert>
  <delete id="deleteDept" parameterType="Long">
    delete from dept where deptno=#{id}
  </delete>
  <update id="updateDept" parameterType="com.ths.api.pojo.Dept">
    update dept set dname=#{dname} where deptno=#{deptno}
  </update>
</mapper>
```

### 服务层

```java
// 接口
package com.ths.provider.service;

import com.ths.api.pojo.Dept;

import java.util.List;

public interface DeptService {
  public List<Dept> queryAll();

  public Dept queryById(Long id);

  public boolean addDept(Dept dept);

  public boolean deleteDept(Long id);

  public boolean updateDept(Dept dept);
}

// 实现类
package com.ths.provider.service;

import com.ths.api.pojo.Dept;
import com.ths.provider.mapper.DeptMapper;
import org.springframework.stereotype.Service;

import java.util.List;

@Service // 同@Component一样，交给Spring托管，service层使用@Service
public class DeptServiceImpl implements DeptService{
  private final DeptMapper mapper;

  public DeptServiceImpl(DeptMapper mapper) {
    this.mapper = mapper;
  }
  // 这两行等同于上边
  // @Autowired
  // private DeptMapper mapper;

  @Override
  public List<Dept> queryAll() {
    return mapper.queryAll();
  }

  @Override
  public Dept queryById(Long id) {
    Dept dept = mapper.queryById(id);
    System.out.println(dept);
    return dept;
  }

  @Override
  public boolean addDept(Dept dept) {
    return mapper.addDept(dept);
  }

  @Override
  public boolean deleteDept(Long id) {
    return mapper.deleteDept(id);
  }

  @Override
  public boolean updateDept(Dept dept) {
    return mapper.updateDept(dept);
  }
}
```

### 启动项

```java
package com.ths.provider;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Provider_8001 {
  public static void main(String[] args) {
    SpringApplication.run(Provider_8001.class, args);
  }
}
```
