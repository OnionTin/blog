## 消费者服务

> 消费者服务，通过 RestTemplate 来调用生产者提供的接口，实现页面的展示等

### 依赖

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project
  xmlns="http://maven.apache.org/POM/4.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
  http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <parent>
    <artifactId>ths-spring-cloud</artifactId>
    <groupId>org.ths</groupId>
    <version>1.0-SNAPSHOT</version>
  </parent>
  <modelVersion>4.0.0</modelVersion>

  <artifactId>project-consumer-80</artifactId>

  <properties>
    <maven.compiler.source>8</maven.compiler.source>
    <maven.compiler.target>8</maven.compiler.target>
  </properties>

  <dependencies>
    <!--消费者也需要实体类，导入project-api模块-->
    <dependency>
      <groupId>org.ths</groupId>
      <artifactId>project-api</artifactId>
      <version>1.0-SNAPSHOT</version>
    </dependency>
    <!--springboot-->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!--devtools-->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-devtools</artifactId>
    </dependency>
    <!---->
    <dependency>
      <groupId>org.mybatis</groupId>
      <artifactId>mybatis</artifactId>
      <version>3.5.6</version>
      <scope>compile</scope>
    </dependency>
  </dependencies>

</project>
```

### 配置文件

```yaml
server:
  port: 808
spring:
  application:
    name: project-consumer-80
```

### 注册 RestTemplate

```java
package com.ths.consumer.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration // 将方法返回的RestTemplate注册到Spring中
public class BeanConfig {
  @Bean // 将RestTemplate交给Spring托管
  public RestTemplate getRestTemplate() {
    return new RestTemplate();
  }
}
```

### 控制层

```java
package com.ths.consumer.controller;

import com.ths.api.pojo.Dept;
import org.apache.ibatis.annotations.Param;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.util.List;

@RestController // 只能用@RestController，不能用@Controller
@RequestMapping("/consumer/dept")
public class GetDeptController {
  // 消费者不应该有service层了，而是负责获取数据并在页面上渲染即可
  // xxxTemplate 是SpringCloud提供的一个模板，用来调用服务
  // RestTemplate：Spring中默认没有注册，需要自己注册(BeanConfig)

  // RestTemplate：Restful风格服务模板，从提供者模块中获取需要的内容
  // RestTemplate：简单粗暴无脑，直接调用即可

  private final RestTemplate restTemplate; // 注册后就可以使用了

  public GetDeptController(RestTemplate restTemplate) {
    this.restTemplate = restTemplate;
  }

// 服务端请求的url前缀
private static final String REST_URL_PREFIX = "http://localhost:8001";
@GetMapping("/get/{id}")
public Dept getDeptById(@PathVariable("id") Long id) {
  // 参数1：请求地址，参数2：返回类型
  return restTemplate.getForObject(REST_URL_PREFIX + "/dept/get/" + id, Dept.class);
}
@GetMapping("/list")
public List<Dept> queryAll() {
  return restTemplate.getForObject(REST_URL_PREFIX + "/dept/list", List.class);
}
@PostMapping("/add")
public boolean addDept(Dept dept) {
  // 参数1：请求地址，参数2：请求参数，参数3：返回类型
  return Boolean.TRUE.equals(
    restTemplate.postForObject(REST_URL_PREFIX + "/dept/add", dept, Boolean.class)
  );
}
@PostMapping("/delete")
public boolean deleteDept(@Param("id") Long id) {
  return Boolean.TRUE.equals(
    restTemplate.postForObject(REST_URL_PREFIX + "/dept/delete", id, Boolean.class)
  );
}
@PostMapping("/update")
public boolean updateDept(@RequestBody Dept dept) {
  return Boolean.TRUE.equals(
    restTemplate.postForObject(REST_URL_PREFIX + "/dept/update", dept, Boolean.class)
  );
}
}
```

### 启动类

```java
package com.ths.consumer;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Consumer_80 {
  public static void main(String[] args) {
    SpringApplication.run(Consumer_80.class, args);
  }
}
```
