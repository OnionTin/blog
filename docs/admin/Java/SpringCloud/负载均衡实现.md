## 负载均衡实现

### 1. 创建模块

> 分别创建两个模块 project-provider_8002 和 8003，并修改这三个模块的配置文件(就是修改端口和注册中心地址以及名称还有数据库练级等配置信息)

```yaml
# 8001项目
server:
  port: 8001
# mybatis配置
mybatis:
  # 配置别名：实体类包名路径(api模块)
  type-aliases-package: com.ths.api.pojo
  # 配置mapper接口的位置(当前模块)
  mapper-locations: classpath:mybatis/mapper/*.xml
  # 配置全局配置文件(当前模块)
  config-location: classpath:mybatis/mybatis-config.xml
# spring配置
spring:
  application:
    # 因为配置负载均衡，所以多个服务的名字要一致
    # name: project-provider-8001
    name: project-provider
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/db01?useUnicode
      =true&characterEncoding=utf-8&serverTimezone=UTC
    username: root
    password: 123456
# Eureka配置
eureka:
  client:
    serviceUrl:
      # 将本服务注册到哪个注册中心(单机)
      # defaultZone: http://localhost:7001/eureka/
      # 集群
      defaultZone: http://eureka7001.com:7001/eureka/,
      http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/
  # 修改服务在注册中心的名字
  instance:
    instance-id: project-provider-8001-id
# 配置监控信息(访问地址: http://localhost:8001/actuator/info)
info:
  app.name: project-provider-8001
  app.description: project-provider-8001
  company.name: th
```

```yaml
# 8002项目
server:
  port: 8002
# mybatis配置
mybatis:
  # 配置别名：实体类包名路径(api模块)
  type-aliases-package: com.ths.api.pojo
  # 配置mapper接口的位置(当前模块)
  mapper-locations: classpath:mybatis/mapper/*.xml
  # 配置全局配置文件(当前模块)
  config-location: classpath:mybatis/mybatis-config.xml
# spring配置
spring:
  application:
    # 因为配置负载均衡，所以多个服务的名字要一致
    # name: project-provider-8002
    name: project-provider
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/db02?
      useUnicode=true&characterEncoding=utf-8&serverTimezone=UTC
    username: root
    password: 123456
# Eureka配置
eureka:
  client:
    serviceUrl:
      # 将本服务注册到哪个注册中心(单机)
      # defaultZone: http://localhost:7001/eureka/
      # 集群
      defaultZone: http://eureka7001.com:7001/eureka/,
      http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/
  # 修改服务在注册中心的名字
  instance:
    instance-id: project-provider-8002-id
# 配置监控信息(访问地址: http://localhost:8001/actuator/info)
info:
  app.name: project-provider-8002
  app.description: project-provider-8002
  company.name: ths
```

### 2. 配置负载均衡

#### 1.project-consumer-80 项目导入依赖

```xml
<!--Ribbon：客户端实现负载均衡-->
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-ribbon</artifactId>
  <version>1.4.6.RELEASE</version>
</dependency>
<!--Eureka：需要发现-->
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-eureka</artifactId>
  <version>1.4.6.RELEASE</version>
</dependency>
```

#### 2. 修改配置文件

```yaml
server:
  port: 808
spring:
  application:
    name: project-consumer-80
# Eureka
eureka:
  client:
    # 不注册自己
    register-with-eureka: false
    # 从注册中心获取服务
    service-url:
      defaultZone: http://eureka7002.com:7002/eureka/,
      http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/
```

#### 3. 配置实现负载均衡的 RestTemplate

```java
package com.ths.consumer.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration // 将方法返回的RestTemplate注册到Spring中
public class BeanConfig {
  @Bean // 将RestTemplate交给Spring托管
  @LoadBalanced // 配置实现负载均衡的RestTemplate
  public RestTemplate getRestTemplate() {
    return new RestTemplate();
  }
}
```

#### 4. 修改调用服务的方法

```java
package com.ths.consumer.controller;

import com.ths.api.pojo.Dept;
import org.apache.ibatis.annotations.Param;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.util.List;

@RestController // 只能用@RestController，不能用@Controller
@RequestMapping("/consumer/dept")
public class GetDeptController {
  // 消费者不应该有service层了，而是负责获取数据并在页面上渲染即可
  // xxxTemplate 是SpringCloud提供的一个模板，用来调用服务
  // RestTemplate：Spring中默认没有注册，需要自己注册(BeanConfig)

  // RestTemplate：Restful风格服务模板，从提供者模块中获取需要的内容
  // RestTemplate：简单粗暴无脑，直接调用即可

  // 服务端请求的url前缀(单机)
  // private static final String REST_URL_PREFIX = "http://localhost:8001";
  // 负载均衡：集群(通过服务名访问)
  // 注意：多个服务的名称要统一为这个名称
  private static final String REST_URL_PREFIX = "http://PROJECT-PROVIDER";
  // 注册后就可以使用了
  private final RestTemplate restTemplate;

  public GetDeptController(RestTemplate restTemplate) {
    this.restTemplate = restTemplate;
  }

  @GetMapping("/list")
  public List<Dept> queryAll() {
    return restTemplate.getForObject(REST_URL_PREFIX + "/dept/list", List.class);
  }
}
```

#### 5. 启动类

```java
package com.ths.consumer;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
// 服务注册与发现
@EnableEurekaClient
public class Consumer_80 {
  public static void main(String[] args) {
    SpringApplication.run(Consumer_80.class, args);
  }
}
```

[运行后访问地址](http://localhost:808/consumer/dept/list)，这个接口返回的数据每次都不一样，实现了 Ribbon 的轮询机制。

![负载均衡](./images/负载均衡.jpg)
